From 608d4c8e02beda34112449333561474368d0eda0 Mon Sep 17 00:00:00 2001
From: Anuj Mittal <anujx.mittal@intel.com>
Date: Fri, 1 Apr 2016 11:47:39 +0800
Subject: [PATCH] mraa: update to version 0.10.1

Also fix packaging errors related to incorrect paths.

Signed-off-by: Anuj Mittal <anujx.mittal@intel.com>
---
 .../recipes-devtools/mraa/mraa.inc                 |  4 +-
 .../0001-mraa-point-to-correct-install-paths.patch | 52 ++++++++++++++++++++++
 .../mraa/{mraa_0.9.0.bb => mraa_0.10.1.bb}         |  3 +-
 3 files changed, 56 insertions(+), 3 deletions(-)
 create mode 100644 meta-intel-iot-middleware/recipes-devtools/mraa/mraa/0001-mraa-point-to-correct-install-paths.patch
 rename meta-intel-iot-middleware/recipes-devtools/mraa/{mraa_0.9.0.bb => mraa_0.10.1.bb} (41%)

diff --git a/meta-intel-iot-middleware/recipes-devtools/mraa/mraa.inc b/meta-intel-iot-middleware/recipes-devtools/mraa/mraa.inc
index 7a3dbfd..9485aff 100644
--- a/meta-intel-iot-middleware/recipes-devtools/mraa/mraa.inc
+++ b/meta-intel-iot-middleware/recipes-devtools/mraa/mraa.inc
@@ -3,7 +3,7 @@ SECTION = "libs"
 AUTHOR = "Brendan Le Foll, Tom Ingleby"
 
 LICENSE = "MIT"
-LIC_FILES_CHKSUM = "file://COPYING;md5=e8db6501ed294e65418a933925d12058"
+LIC_FILES_CHKSUM = "file://COPYING;md5=66493d54e65bfc12c7983ff2e884f37f"
 
 S = "${WORKDIR}/git"
 
@@ -18,7 +18,7 @@ PACKAGECONFIG ??= "python nodejs"
 PACKAGECONFIG[python] = "-DBUILDSWIGPYTHON=ON, -DBUILDSWIGPYTHON=OFF, swig-native python"
 PACKAGECONFIG[nodejs] = "-DBUILDSWIGNODE=ON, -DBUILDSWIGNODE=OFF, swig-native nodejs"
 
-EXTRA_OECMAKE_append = "-DINSTALLGPIOTOOL=ON"
+EXTRA_OECMAKE_append = "-DINSTALLGPIOTOOL=ON -DPYTHON_SITE_DIR:FILEPATH=${PYTHON_SITEPACKAGES_DIR} -DBASE_LIB_INSTALL_DIR=${base_libdir} -DCMAKE_SKIP_RPATH=ON"
 
 do_compile_prepend () {
   # when yocto builds in ${D} it does not have access to ../git/.git so git
diff --git a/meta-intel-iot-middleware/recipes-devtools/mraa/mraa/0001-mraa-point-to-correct-install-paths.patch b/meta-intel-iot-middleware/recipes-devtools/mraa/mraa/0001-mraa-point-to-correct-install-paths.patch
new file mode 100644
index 0000000..40fd309
--- /dev/null
+++ b/meta-intel-iot-middleware/recipes-devtools/mraa/mraa/0001-mraa-point-to-correct-install-paths.patch
@@ -0,0 +1,52 @@
+From e894e1675e5c59c125614fb89ebf17c64d8f4c48 Mon Sep 17 00:00:00 2001
+From: Anuj Mittal <anujx.mittal@intel.com>
+Date: Fri, 1 Apr 2016 11:34:19 +0800
+Subject: [PATCH] mraa: point to correct install paths
+
+Use PYTHON_SITEPACKAGES_DIR variable from python-dir bbclass for
+PYTHON_SITE_DIR and use generic LIB_INSTALL_DIR path.
+
+Signed-off-by: Anuj Mittal <anujx.mittal@intel.com>
+---
+ src/javascript/CMakeLists.txt | 4 ++--
+ src/python/CMakeLists.txt     | 6 +-----
+ 2 files changed, 3 insertions(+), 7 deletions(-)
+
+diff --git a/src/javascript/CMakeLists.txt b/src/javascript/CMakeLists.txt
+index d54d77a..09714ef 100644
+--- a/src/javascript/CMakeLists.txt
++++ b/src/javascript/CMakeLists.txt
+@@ -57,11 +57,11 @@ endif ()
+ # If a CMAKE_INSTALL_PREFIX has NOT been provided, set NODE_MODULE_INSTALL_PATH
+ # base on the NODE_ROOT_DIR.
+ if (CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
+-  set (NODE_MODULE_INSTALL_PATH ${NODE_ROOT_DIR}/lib/node_modules/mraa/)
++  set (NODE_MODULE_INSTALL_PATH ${NODE_ROOT_DIR}/${BASE_LIB_INSTALL_DIR}/node_modules/mraa/)
+ # If a CMAKE_INSTALL_PREFIX has been provided, set NODE_MODULE_INSTALL_PATH
+ # relative to the provide install directory.
+ else (CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
+-  set (NODE_MODULE_INSTALL_PATH ${CMAKE_INSTALL_PREFIX}/lib/node_modules/mraa/)
++  set (NODE_MODULE_INSTALL_PATH ${CMAKE_INSTALL_PREFIX}/${BASE_LIB_INSTALL_DIR}/node_modules/mraa/)
+ endif (CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
+ message (STATUS "INFO - install NODE modules to ${NODE_MODULE_INSTALL_PATH}")
+ 
+diff --git a/src/python/CMakeLists.txt b/src/python/CMakeLists.txt
+index c51ccd1..6db54f6 100644
+--- a/src/python/CMakeLists.txt
++++ b/src/python/CMakeLists.txt
+@@ -34,11 +34,7 @@ execute_process (
+    OUTPUT_VARIABLE PYTHON_PREFIX
+ )
+ file (TO_CMAKE_PATH "${PYTHON_PREFIX}" PYTHON_PREFIX)
+-execute_process (
+-   COMMAND ${PYTHON_EXECUTABLE} -c
+-       "import site, sys; sys.stdout.write(site.getusersitepackages().replace(site.getuserbase(), site.PREFIXES[-1]))"
+-   OUTPUT_VARIABLE PYTHON_SITE_DIR
+-)
++
+ file (TO_CMAKE_PATH "${PYTHON_SITE_DIR}" PYTHON_SITE_DIR)
+ string (REGEX REPLACE "^${PYTHON_PREFIX}/" ""
+    PYTHON_SITE_DIR "${PYTHON_SITE_DIR}")
+-- 
+1.9.1
+
diff --git a/meta-intel-iot-middleware/recipes-devtools/mraa/mraa_0.9.0.bb b/meta-intel-iot-middleware/recipes-devtools/mraa/mraa_0.10.1.bb
similarity index 41%
rename from meta-intel-iot-middleware/recipes-devtools/mraa/mraa_0.9.0.bb
rename to meta-intel-iot-middleware/recipes-devtools/mraa/mraa_0.10.1.bb
index a2c02b9..b190acb 100644
--- a/meta-intel-iot-middleware/recipes-devtools/mraa/mraa_0.9.0.bb
+++ b/meta-intel-iot-middleware/recipes-devtools/mraa/mraa_0.10.1.bb
@@ -1,3 +1,4 @@
 require mraa.inc
 
-SRC_URI = "git://github.com/intel-iot-devkit/mraa.git;protocol=git;rev=d430b5c2b5b282e40bc705a28158b3d682d722f5"
+SRC_URI = "git://github.com/intel-iot-devkit/mraa.git;protocol=git;rev=a9429204e38416e04edbc1a6b5fe6ba49379493d \
+           file://0001-mraa-point-to-correct-install-paths.patch"
-- 
1.9.1

